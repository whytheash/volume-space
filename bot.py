import os
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, types, F
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.filters import Command
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import FSInputFile
from motor.motor_asyncio import AsyncIOMotorClient
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from aiogram.exceptions import TelegramUnauthorizedError
from telegram.ext import Updater
from datetime import datetime, timedelta, timezone

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
TOKEN = os.environ.get("TELEGRAM_TOKEN")
bot = Bot(token=TOKEN)
dp = Dispatcher()


# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB
MONGODB_URI = os.environ.get("MONGO_URL")
client = AsyncIOMotorClient(MONGODB_URI)
db = client["volume-space"]
users_collection = db["users_data"]
results_collection = db["test_results"]

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
scheduler = AsyncIOScheduler()


TYPES = {
    "–ß–∏–ª–ª –≥–∞–π": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 1, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 7, "–ì–∏–±–∫–æ—Å—Ç—å": 6, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 2, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 1, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 1, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 1},
    "–¢—Ä—É –∞—Ä—Ç–∏—Å—Ç": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 8, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 11, "–ì–∏–±–∫–æ—Å—Ç—å": 10, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 7, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 9, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 2, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 2},
    "–ù–µ—Ñ–æ—Ä–º–∞–ª": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 6, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 10, "–ì–∏–±–∫–æ—Å—Ç—å": 9, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 4, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 2, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 1, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 1},
    "–ë–ª—ç–∫–≤–æ—Ä–∫–µ—Ä": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 10, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 5, "–ì–∏–±–∫–æ—Å—Ç—å": 1, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 11, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 5, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 1, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 2},
    "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 4, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 1, "–ì–∏–±–∫–æ—Å—Ç—å": 11, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 5, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 8, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 4, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 5},
    "–û–ø–æ–∑–¥—É–Ω": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 7, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 6, "–ì–∏–±–∫–æ—Å—Ç—å": 8, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 1, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 4, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 2, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 2},
    "–†–µ–∞–ª—å–Ω—ã–π —Ö–∞—Ä–¥": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 11, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 9, "–ì–∏–±–∫–æ—Å—Ç—å": 7, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 10, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 10, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 4, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 7},
    "–í —Ç–∏—Ö–æ–º –æ–º—É—Ç–µ": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 3, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 4, "–ì–∏–±–∫–æ—Å—Ç—å": 4, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 3, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 7, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 2, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 2},
    "–ú–∏–Ω–∏-—Ç–∞—Ç—É": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 2, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 2, "–ì–∏–±–∫–æ—Å—Ç—å": 3, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 9, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 6, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 5, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 3},
    "–ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 9, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 3, "–ì–∏–±–∫–æ—Å—Ç—å": 5, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 6, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 11, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 1, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 3},
    "–¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª": {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 5, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 8, "–ì–∏–±–∫–æ—Å—Ç—å": 2, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 8, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 3, "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 1, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 1}
}

DESCRIPTIONS = {
    "–ß–∏–ª–ª –≥–∞–π": "–¥–ª—è —Ç–µ–±—è —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∞ –±–æ–ª—å—à–µ –ø–æ—Ö–æ–¥–∏—Ç –Ω–∞ —Ö–æ–±–±–∏, —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ —Å–≤–æ–µ–º —Ä–∞–∑–º–µ—Ä–µ–Ω–Ω–æ–º —Ç–µ–º–ø–µ, –±–µ–∑ —É—â–µ—Ä–±–∞ –∑–¥–æ—Ä–æ–≤—å—é –∏ —Å–≤–æ–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é, —Ç–∞–∫ –¥–µ—Ä–∂–∞—Ç—å!",
    "–¢—Ä—É –∞—Ä—Ç–∏—Å—Ç": "—Ç—ã ‚Äî –Ω–∞—Å—Ç–æ—è—â–∏–π —Ö—É–¥–æ–∂–Ω–∏–∫ –∏–Ω–¥—É—Å—Ç—Ä–∏–∏! —Ç–æ–±–æ–π –¥–≤–∏–∂–µ—Ç –∂–µ–ª–∞–Ω–∏–µ –≤—ã–¥–µ–ª—è—Ç—å—Å—è, —Ç–≤–æ–π —Å—Ç–∏–ª—å.",
    "–ù–µ—Ñ–æ—Ä–º–∞–ª": "—É —Ç–µ–±—è —Å–≤–æ–π –≤–∑–≥–ª—è–¥ –Ω–∞ –∏–Ω–¥—É—Å—Ç—Ä–∏—é, –ª—é–±–∏—à—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –∏ —Å–º–µ–ª—ã–µ —Ä–µ—à–µ–Ω–∏—è!",
    "–ë–ª—ç–∫–≤–æ—Ä–∫–µ—Ä": "—Ç—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –¥–∑–µ–Ω-–º–∞—Å—Ç–µ—Ä! —Ä–æ–≤–Ω—ã–π –ø–ª–æ—Ç–Ω—ã–π –ø–æ–∫—Ä–∞—Å ‚Äî –Ω–µ–ø—Ä–æ—Å—Ç–∞—è –∑–∞–¥–∞—á–∫–∞!",
    "–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π": "—á—Ç–æ-—Ç–æ –ø—Ä–æ —Ç–∞—Ç—É-–∑–∞–≤–æ–¥ —Å–ª—ã—à–∞–ª–∏? —ç—Ç–æ –ø—Ä–æ —Ç–µ–±—è! –Ω–∞–≤–µ—Ä–Ω—è–∫–∞ –∑–∞ —Ç–≤–æ–∏–º–∏ –ø–ª–µ—á–∞–º–∏ –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç.",
    "–û–ø–æ–∑–¥—É–Ω": "—Å –∫–µ–º –Ω–µ –±—ã–≤–∞–µ—Ç! —Å–∏—Ç—É–∞—Ü–∏–∏ —Ä–∞–∑–Ω—ã–µ, –Ω–æ —Ç—ã —Ä–∏—Å–∫—É–µ—à—å –ø–æ—Ç–µ—Ä—è—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤, –Ω–µ —Å—Ç–æ–∏—Ç —Ä–∞—Å—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è! —ç—Ç—É —Å–∏—Ç—É–∞—Ü–∏—é –º–æ–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–º–Ω–æ–≥–æ –ø–æ—Ä–∞–±–æ—Ç–∞–≤ —Å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–æ–π!",
    "–†–µ–∞–ª—å–Ω—ã–π —Ö–∞—Ä–¥": "—Ç—ã –Ω–∞—Å—Ç–æ—è—â–∏–π —Ñ–∞–Ω–∞—Ç —Å–≤–æ–µ–≥–æ –¥–µ–ª–∞! –Ω–æ –Ω–µ –∑–∞–±—ã–≤–∞–π –æ—Ç–¥—ã—Ö–∞—Ç—å –∏ –∏–Ω–æ–≥–¥–∞ —Ö–æ–¥–∏—Ç—å –Ω–∞ –º–∞—Å—Å–∞–∂–∏!",
    "–í —Ç–∏—Ö–æ–º –æ–º—É—Ç–µ": "—á–µ—Ä—Ç–∏ –≤–æ–¥—è—Ç—Å—è‚Ä¶ –∏–Ω–æ–≥–¥–∞ —Ç—ã –±–µ—Ä–µ—à—å—Å—è –∑–∞ –ø—Ä–æ–µ–∫—Ç—ã –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ –¥–ª—è —Ç–µ–±—è –∏ —Ç–≤–æ–µ–≥–æ —Å—Ç–∏–ª—è, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —ç—Ç–æ –∫—Ä—É—Ç–æ!",
    "–ú–∏–Ω–∏-—Ç–∞—Ç—É": "—Ç—ã - –º–∞—Å—Ç–µ—Ä –º–∏–Ω–∏–∞—Ç—é—Ä! –¥–µ–ª–æ, –∫–æ—Ç–æ—Ä–æ–µ –¥–∞–Ω–æ –¥–∞–ª–µ–∫–æ –Ω–µ –∫–∞–∂–¥–æ–º—É!",
    "–ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞": "–∫–∞–∂–µ—Ç—Å—è —Ç—ã –ø–µ—Ä–µ–ø—É—Ç–∞–ª –¥–µ–Ω—å —Å –Ω–æ—á—å—é! –∞ –º–æ–∂–µ—Ç —É —Ç–µ–±—è —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ —Ç–µ–±–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å —Å–Ω–æ–º? –≤–µ—Ä—é —á—Ç–æ —Ç–≤–æ–∏ —Å—Ç–∞—Ä–∞–Ω–∏—è –¥–∞–¥—É—Ç –±–æ–ª—å—à–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!",
    "–¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª": "–≤—Å–µ —Å —á–µ–≥–æ-—Ç–æ –Ω–∞—á–∏–Ω–∞—é—Ç, –≤–æ–∑–º–æ–∂–Ω–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ –ø—Ä–∞–∫—Ç–∏–∫–∏, –Ω–µ —Å–¥–∞–≤–∞–π—Å—è - —Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥!"
}

class TestStates(StatesGroup):
    Q1 = State()
    Q2 = State()
    Q3 = State()
    Q4 = State()
    Q5 = State()
    Q6 = State()
    Q7 = State()
    Q8 = State()
    Q9 = State()
    Q10 = State()
    Q11 = State()
    Q12 = State()

QUESTIONS = {
    TestStates.Q1: (
        "1. —Ç—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—à—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –∞ —Ç–∞–º 5 –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–¥—Ä—è–¥. \n—á—Ç–æ —Å–¥–µ–ª–∞–µ—à—å?",
        ["A. –≥–ª–∞–∑–∞ –±–æ—è—Ç—Å—è - –∞ —Ä—É–∫–∏ –¥–µ–ª–∞—é—Ç", "B. —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—é —á–∞—Å—Ç—å —Ä–∞–±–æ—Ç—ã –Ω–∞ –¥—Ä—É–≥–∏–µ –¥–Ω–∏", "C. –∑–∞–±—å—é—Å—å –≤ –∏—Å—Ç–µ—Ä–∏–∫–µ –≤ —É–≥–æ–ª"]
    ),
    TestStates.Q2: (
        "2. —Ç—ã —Ä–µ—à–∏–ª —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ—Ä—ã–≤ —Å –∫–ª–∏–µ–Ω—Ç–æ–º. \n—Å–∫–æ–ª—å–∫–æ –æ–Ω –ø—Ä–æ–¥–ª–∏—Ç—Å—è?",
        ["A. 15 –º–∏–Ω—É—Ç ‚Äî —Ö–≤–∞—Ç–∏—Ç —Å –≥–æ–ª–æ–≤–æ–π", "B. –Ω–µ –º–µ–Ω—å—à–µ 30 –º–∏–Ω—É—Ç", "C. —á–∞—Å, –∞ —Ç–æ –∏ –¥–≤–∞, –Ω—É–∂–Ω–æ –∂–µ –Ω–∞–±—Ä–∞—Ç—å—Å—è —Å–∏–ª"]
    ),
    TestStates.Q3: (
        "3. —Ç–≤–æ–π –∫–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç —ç—Å–∫–∏–∑ –∏–∑ –ø–∏–Ω—Ç–µ—Ä–µ—Å—Ç–∞, —Ç–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è?",
        ["A. —Ä–∞–±–æ—Ç–∞–µ–º, –¥–µ–Ω—å–≥–∏ –Ω–µ –ø–∞—Ö–Ω—É—Ç", "B. –ø—Ä–µ–¥–ª–æ–∂—É —Å–≤–æ—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É", "C. *–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å*"]
    ),
    TestStates.Q4: (
        "4. —Ç–µ–ø–µ—Ä—å –∫–ª–∏–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –º–µ–Ω—è–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ç —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∏ –≤ –¥–µ–Ω—å —Å–µ–∞–Ω—Å–∞",
        ["A. —è –∑–∞ –ª—é–±—ã–µ –∏–¥–µ–∏, —Ñ—Ä–∏—Ö–µ–Ω–¥ - –≤–ø–µ—Ä–µ–¥!", "B. –ø—Ä–µ–¥–ª–æ–∂—É —Å–≤–æ–±–æ–¥–Ω—ã–µ —ç—Å–∫–∏–∑—ã", "C. –º–µ–Ω—è—Ç—å –ø–æ–∑–¥–Ω–æ, –ø–µ—Ä–µ–Ω–µ—Å—É —Å–µ–∞–Ω—Å"]
    ),
    TestStates.Q5: (
        "5. —Ç–≤–æ–π –∫–ª–∏–µ–Ω—Ç –Ω–∞—á–∞–ª –∞–∫—Ç–∏–≤–Ω–æ –∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –±–æ–ª—å, —á—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å?",
        ["A. —Å–æ—Ä—Ä–∏, –Ω–µ –Ω–∞ –º–∞—Å—Å–∞–∂ –ø—Ä–∏—à–µ–ª", "B. –ø—Ä–µ–¥–ª–æ–∂—É –æ–±–µ–∑–±–æ–ª–∏—Ç—å –∫–æ–∂—É", "C. –±—É–¥—É —Å—Ç—Ä–∞–¥–∞—Ç—å –≤–º–µ—Å—Ç–µ —Å –Ω–∏–º"]
    ),
    TestStates.Q6: (
        "6. —Ç—ã –ø—Ä–∏—Ö–æ–¥–∏—à—å –≤ —Å—Ç—É–¥–∏—é, –∞ —Ç–∞–º –ø–ª–æ—Ç–Ω–∞—è –ø–æ—Å–∞–¥–∫–∞. –º–µ—Å—Ç–∞ –¥–ª—è –≤–∞—Å –Ω–µ –Ω–∞—à–ª–∏...",
        ["A. –Ω–∞–π–¥—É –¥—Ä—É–≥—É—é —Å—Ç—É–¥–∏—é", "B. –ø–µ—Ä–µ–Ω–µ—Å—É —Å–µ–∞–Ω—Å –Ω–∞ –¥—Ä—É–≥–æ–π –¥–µ–Ω—å", "C. —É—Å—Ç—Ä–æ—é —Å–∫–∞–Ω–¥–∞–ª –Ω–∞ —Å—Ç—É–¥–∏–∏"]
    ),
    TestStates.Q7: (
        "7. –¥—Ä—É–≥ –∑–æ–≤–µ—Ç –≤ –±–∞—Ä, –Ω–æ –∑–∞–≤—Ç—Ä–∞ —É —Ç–µ–±—è —Å–µ–∞–Ω—Å. \n–∫–∞–∫ –±—É–¥–µ–º –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å?",
        ["A. –Ω–µ –ø–æ–π–¥—É, –Ω–∞ –∑–∞–≤—Ç—Ä–∞ —ç—Å–∫–∏–∑ –≥–æ—Ç–æ–≤–∏—Ç—å", "B. –∑–∞–ª–µ—á—É –Ω–∞ –ø–∞—Ä—É —á–∞—Å–æ–≤ –∏ –¥–æ–º–æ–π", "C. –ø–µ—Ä–µ–Ω–µ—Å—É —Å–µ–∞–Ω—Å –∏ –±—É–¥—É —Ç—É—Å–∏—Ç—å –¥–æ —É—Ç—Ä–∞"]
    ),
    TestStates.Q8: (
        "8. –∫–∞–∂–µ—Ç—Å—è, —Ç—ã –æ–ø–∞–∑–¥—ã–≤–∞–µ—à—å –Ω–∞ —Å–µ–∞–Ω—Å –Ω–∞ 30 –º–∏–Ω—É—Ç...",
        ["A. –≤—ã–∑–æ–≤—É —Ç–∞–∫—Å–∏, –ø—Ä–∏–µ–¥—É –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–∞–Ω—å—à–µ", "B. –∏–∑–≤–∏–Ω—é—Å—å –∏ –ø—Ä–µ–¥–ª–æ–∂—É —Å–∫–∏–¥–∫—É", "C. –∫–∞–∫ –ø—Ä–∏–¥—É, —Ç–∞–∫ –∏ –ø—Ä–∏–¥—É"]
    ),
    TestStates.Q9: (
        "9. –¥–æ —Å–µ–∞–Ω—Å–∞ 15 –º–∏–Ω—É—Ç. –∫–ª–∏–µ–Ω—Ç –ø–∏—à–µ—Ç, —á—Ç–æ –µ–≥–æ –Ω–µ –±—É–¥–µ—Ç –∏ –ø—Ä–æ—Å–∏—Ç –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–µ–∞–Ω—Å. \n—á—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å?",
        ["A. –æ–±–æ–∑–ª—é—Å—å, –Ω–æ –Ω–µ –ø–æ–¥–∞–º –≤–∏–¥–∞", "B. ¬´–æ—Ç–¥–∞–º –æ–∫–æ—à–∫–æ —Å–æ —Å–∫–∏–¥–∫–æ–π¬ª", "C. –Ω–µ –±—É–¥—É —Å –Ω–∏–º —Ä–∞–±–æ—Ç–∞—Ç—å..."]
    ),
    TestStates.Q10: (
        "10. —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –±–ª–∏–∑–∏—Ç—Å—è –∫ –∫–æ–Ω—Ü—É, —Ç—ã —É–∂–µ –¥–æ–≤–æ–ª—å–Ω–æ —É—Å—Ç–∞–≤—à–∏–π. \n–∏ —Ç—É—Ç –∫–ª–∏–µ–Ω—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–¥–∞–≤–∞—Ç—å –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤...",
        ["A. –æ–±—ä—è—Å–Ω—é –≤—Å–µ –Ω—é–∞–Ω—Å—ã –∏ —É—Å–ø–æ–∫–æ—é", "B. –±—É–¥—É –∑–∞–¥–∞–≤–∞—Ç—å –º–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –æ—Ç–≤–µ—Ç", "C. —Å—è–¥—É –≤ –Ω–∞—É—à–Ω–∏–∫–∏"]
    ),
    TestStates.Q11: (
        "11. –∫–∞–∫–∏–º –±—ã –±—ã–ª —Ç–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫?",
        ["A. 1-2 –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –Ω–µ —Å–ø–µ—à–∞", "B. 3-4 –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å", "C. 5+ –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äî –∏ —ç—Ç–æ –Ω–µ –ø—Ä–µ–¥–µ–ª!"]
    ),
    TestStates.Q12: (
        "12. –≤ –Ω–µ–¥–µ–ª—é —Ç—ã —Ö–æ—Ç–µ–ª(–∞) –±—ã —Ä–∞–±–æ—Ç–∞—Ç—å...",
        ["A. 1-2 –¥–Ω—è ‚Äî –∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ!", "B. 3-4 –¥–Ω—è ‚Äî –Ω–∞ –±–∞–ª–∞–Ω—Å–µ", "C. 5-7 –¥–Ω–µ–π ‚Äî —Ä–∞–±–æ—Ç–∞—é –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"]
    )
}

user_data = {}
start_message = "<b>–ø—Ä–∏–≤–µ—Ç —Ç–∞—Ç—É–µ—Ä! –Ω–∞ —Å–≤—è–∑–∏ –≤–æ–ª—é–º!</b> \n\n" \
"–º—ã –ø—Ä–æ–¥–µ–ª–∞–ª–∏ –±–æ–ª—å—à–æ–π –ø—É—Ç—å –≤–º–µ—Å—Ç–µ —Å –∫–æ–º–∞–Ω–¥–æ–π, —á—Ç–æ–±—ã –≤ –∏—Ç–æ–≥–µ —ç—Ç–æ—Ç —Ç–µ—Å—Ç –≤—ã—à–µ–ª –≤ —Å–≤–µ—Ç. <b>–Ω–∞–¥–µ–µ–º—Å—è, —á—Ç–æ –æ–Ω —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è, –∞ –º–æ–∂–µ—Ç –¥–∞–∂–µ –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç –Ω–∞ —á—Ç–æ-—Ç–æ –Ω–æ–≤–æ–µ!</b> \n\n<b>—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–≥—É—Ç –ø–æ–º–æ—á—å –ø–æ–Ω—è—Ç—å –≤ –∫–∞–∫–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ–π—á–∞—Å —Ç—ã –Ω–æ–≤–∏—á–æ–∫ –∏–ª–∏ –≤–æ–≤—Å–µ –Ω–µ –∑–Ω–∞–∫–æ–º —Å –∏–Ω–¥—É—Å—Ç—Ä–∏–µ–π.</b>\n\n" \
"—Ö–æ—Ç–∏–º –Ω–∞–ø–æ–º–Ω–∏—Ç—å: —ç—Ç–æ—Ç —Ç–µ—Å—Ç —Å–æ–∑–¥–∞–Ω <b>–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ —Ü–µ–ª—è—Ö —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è</b>. –æ–Ω –ø—Ä–∏–º–µ—Ä–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø–æ —Ç–≤–æ–∏–º –¥–µ–π—Å—Ç–≤–∏—è–º –≤ —Ç–∞—Ç—É-–∏–Ω–¥—É—Å—Ç—Ä–∏–∏ –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å–≤–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ –ø–æ-–Ω–æ–≤–æ–º—É,\n–Ω–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ—Ü–µ–Ω–∫–æ–π –∏–ª–∏ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é. \n\n" \
"<b>–ø–æ–µ—Ö–∞–ª–∏!</b>"


async def on_startup():
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞...")
    try:
        scheduler.start()
        print("‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω")
        scheduler.add_job(check_pending_guides, "interval", minutes=1)
        print("‚úÖ –ó–∞–¥–∞—á–∞ check_pending_guides –¥–æ–±–∞–≤–ª–µ–Ω–∞")
        await check_pending_guides()
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: {str(e)}")


@dp.message(Command("start"))
async def start_test(message: types.Message, state: FSMContext):

    
    #–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = message.from_user
    user_data = {
        "user_id": user.id,
        "username": user.username,
        "first_name": user.first_name,
        "last_name": user.last_name,
        "registration_date": datetime.now()
    }
    await users_collection.update_one(
        {"user_id": user.id},
        {"$setOnInsert": user_data},
        upsert=True
    )


    #–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    startpicture = FSInputFile("img/logo.JPG")


    await bot.send_photo(
        chat_id=message.chat.id,
        photo=startpicture,
        caption=start_message,
        parse_mode="HTML"
    )
    # await message.answer(start_message)
    await state.set_state(TestStates.Q1)
    await ask_question(message, state)

async def ask_question(message: types.Message, state: FSMContext):
    current_state = await state.get_state()
    text, buttons = QUESTIONS[current_state]
    builder = InlineKeyboardBuilder()
    for btn in buttons:
        button_text = btn.split(". ", 1)[1]
        builder.add(types.InlineKeyboardButton(text=button_text, callback_data=btn[0]))
    builder.adjust(1)
    await message.answer(text, reply_markup=builder.as_markup())

@dp.callback_query(F.data.in_(['A', 'B', 'C']))
async def handle_button(callback: types.CallbackQuery, state: FSMContext):
    current_state = await state.get_state()
    user_id = callback.from_user.id
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º
    text, buttons = QUESTIONS[current_state]
    chosen_answer = next(btn for btn in buttons if btn.startswith(callback.data))
    await callback.message.edit_text(
        text=f"{text}\n\n –í–∞—à –≤—ã–±–æ—Ä: {chosen_answer.split('. ', 1)[1]}",
        reply_markup=None
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
    user_data.setdefault(user_id, {"answers": {}})
    user_data[user_id]["answers"][current_state] = callback.data
    
    # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
    next_states = {
        TestStates.Q1: TestStates.Q2,
        TestStates.Q2: TestStates.Q3,
        TestStates.Q3: TestStates.Q4,
        TestStates.Q4: TestStates.Q5,
        TestStates.Q5: TestStates.Q6,
        TestStates.Q6: TestStates.Q7,
        TestStates.Q7: TestStates.Q8,
        TestStates.Q8: TestStates.Q9,
        TestStates.Q9: TestStates.Q10,
        TestStates.Q10: TestStates.Q11,
        TestStates.Q11: TestStates.Q12,
        TestStates.Q12: None
    }
    next_state = next_states.get(current_state)
    
    if next_state:
        await state.set_state(next_state)
        await ask_question(callback.message, state)
    else:
        await calculate_result(callback.message, user_id)
        await state.clear()

async def calculate_result(message: types.Message, user_id: int):
    answers = user_data[user_id]["answers"]
    scores = {
        "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 0, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 0, "–ì–∏–±–∫–æ—Å—Ç—å": 0,
        "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 0, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 0,
        "–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å": 0, "–†–∞–±–æ—á–∏–µ –¥–Ω–∏": 0
    }
    
    scoring_rules = {
        TestStates.Q1: {'A': {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å":7}, 'B': {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å":5}, 'C': {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å":-2}},
        TestStates.Q2: {'A': {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å":4}, 'B': {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å":2}, 'C': {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å":1}},
        TestStates.Q3: {'A': {"–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å":5}, 'B': {"–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å":7}, 'C': {"–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å":-2}},
        TestStates.Q4: {'A': {"–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å":4}, 'B': {"–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å":2}, 'C': {"–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å":1}},
        TestStates.Q5: {'A': {"–ì–∏–±–∫–æ—Å—Ç—å":-2}, 'B': {"–ì–∏–±–∫–æ—Å—Ç—å":3}, 'C': {"–ì–∏–±–∫–æ—Å—Ç—å":1}},
        TestStates.Q6: {'A': {"–ì–∏–±–∫–æ—Å—Ç—å":6}, 'B': {"–ì–∏–±–∫–æ—Å—Ç—å":3}, 'C': {"–ì–∏–±–∫–æ—Å—Ç—å":0}},
        TestStates.Q7: {'A': {"–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å":6}, 'B': {"–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å":3}, 'C': {"–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å":0}},
        TestStates.Q8: {'A': {"–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å":5}, 'B': {"–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å":1}, 'C': {"–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å":-3}},
        TestStates.Q9: {'A': {"–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å":5}, 'B': {"–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å":7}, 'C': {"–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å":-2}},
        TestStates.Q10: {'A': {"–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å":4}, 'B': {"–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å":2}, 'C': {"–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å":1}},
        TestStates.Q11: {'A': {"–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å":1}, 'B': {"–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å":3}, 'C': {"–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å":5}},
        TestStates.Q12: {'A': {"–†–∞–±–æ—á–∏–µ –¥–Ω–∏":2}, 'B': {"–†–∞–±–æ—á–∏–µ –¥–Ω–∏":4}, 'C': {"–†–∞–±–æ—á–∏–µ –¥–Ω–∏":6}}
    }
    
    for state, answer in answers.items():
        for key, value in scoring_rules[state][answer].items():
            scores[key] += value

    # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è "–ß–∏–ª–ª –≥–∞—è"
    filtered_types = TYPES.copy()
    if scores["–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å"] < 2 or scores["–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å"] < 1:
        del filtered_types["–ß–∏–ª–ª –≥–∞–π"]

    # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è "–ú–∏–Ω–∏-—Ç–∞—Ç—É" –ø—Ä–∏ –Ω–∏–∑–∫–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
    filtered_types = TYPES.copy()
    if scores["–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å"] < 3:  # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å < 3
        del filtered_types["–ú–∏–Ω–∏-—Ç–∞—Ç—É"]

    # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è "–ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞"
    filtered_types = TYPES.copy()
    if scores["–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å"] < 10: 
        del filtered_types["–ù–æ—á–Ω–∞—è –±–∞–±–æ—á–∫–∞"]
    
    # –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
    weights = {"–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 1, "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å": 1, "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å": 1, "–ì–∏–±–∫–æ—Å—Ç—å": 1, "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å": 1}
    best_match = None
    min_diff = float('inf')
    
    for type_name, params in filtered_types.items():
        diff = sum(
            abs(scores[k] - params[k]) * weights.get(k, 1)
            for k in ["–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å", "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å", "–ì–∏–±–∫–æ—Å—Ç—å", "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å", "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å"]
        )
        diff += abs(scores["–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å"] - params["–ö–ª–∏–µ–Ω—Ç—ã –≤ –¥–µ–Ω—å"]) * 1
        diff += abs(scores["–†–∞–±–æ—á–∏–µ –¥–Ω–∏"] - params["–†–∞–±–æ—á–∏–µ –¥–Ω–∏"]) * 1
        
        if diff < min_diff:
            min_diff = diff
            best_match = type_name
    
    test_completion_time = datetime.now(timezone.utc) + timedelta(minutes=1)

    #–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –ë–î
    test_data = {
        "user_id": user_id,
        "test_date": datetime.now(),
        "best_match": best_match,
        "scores": scores,
        "guide_sent": False,
        "test_completion_time": datetime.now() + timedelta(minutes=1)
    }
    
    await results_collection.insert_one(test_data)  # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –≤—ã–∑–æ–≤


    #–ü–æ–∏—Å–∫ —Ñ–æ—Ç–æ –ø–æ —Ç–∏–ø—É
    typepicture = FSInputFile(f"img/{best_match}.jpg")

    await bot.send_photo(
        chat_id=message.chat.id,
        photo=typepicture,
        caption=f"<b>–í–∞—à —Ç–∏–ø: {best_match}!</b>\n\n{DESCRIPTIONS[best_match]}\n\n"
        f"–µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–ª–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è, –æ—Å—Ç–∞–≤—å –∏—Ö —Ç—É—Ç @vlmsupport \n\n"
        f"<b>—á—Ç–æ–±—ã –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ,\n–Ω–∞–∂–º–∏—Ç–µ /start</b>",
        parse_mode="HTML"
    )

    print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è {user_id}:")
    print(f"‚è± –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–∞–π–¥–∞: {test_completion_time}")
    print(f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç: {best_match}")


async def check_pending_guides():
    print(f"üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞—á –≤ {datetime.now()}")
    try:
        cursor = results_collection.find({
            "guide_sent": False,
            "test_completion_time": {"$lte": datetime.now()}
        })
        
        count = 0
        async for user in cursor:
            count += 1
            print(f"üì¶ –ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: {user['user_id']}")
            try:
                await send_guide(user["user_id"])
                await results_collection.update_one(
                    {"_id": user["_id"]},
                    {"$set": {"guide_sent": True}}
                )
                print(f"‚úÖ –ì–∞–π–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω {user['user_id']}")
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {str(e)}")
        
        print(f"üìä –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    except Exception as e:
        print(f"üî• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)}")

async def send_guide(user_id: int):
    try:
        file_path = os.path.abspath(os.path.join("img", "master-types-compressed.pdf"))
        if not os.path.exists(file_path):
            raise FileNotFoundError(f"PDF –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
            
        await bot.send_document(
            chat_id=user_id,
            document=FSInputFile(file_path),
            caption=f"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞! –í–∞—à –≥–∞–π–¥ –≥–æ—Ç–æ–≤!",
            parse_mode="HTML"
        )
    except TelegramUnauthorizedError:
        print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {str(e)}")

    print(f"üìÑ –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É: {os.path.abspath(file_path)}")
    print(f"üîí –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {os.path.exists(file_path)}")


if __name__ == "__main__":
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
    if not os.path.exists("img/master-types-compressed.pdf"):
        raise FileNotFoundError("PDF guide missing!")
    
    # –Ø–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ –≤ –æ–¥–Ω–æ–ø–æ—Ç–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
    import asyncio
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    
    try:
        loop.run_until_complete(dp.start_polling(bot))
    except KeyboardInterrupt:
        pass
    finally:
        loop.close()


    